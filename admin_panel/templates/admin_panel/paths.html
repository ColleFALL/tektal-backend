{% extends 'admin_panel/base.html' %}
{% block content %}
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<div id="path-app" x-data="{ showModal: false, uploading: false, progress: 0, previewUrl: '' }">
    
    <div class="flex justify-between items-center mb-8 p-4">
        <h2 class="text-3xl font-bold">Gestion des Chemins</h2>
        <button @click="showModal = true" class="px-6 py-3 bg-[#FEBD00] text-white font-bold rounded-2xl shadow-lg hover:bg-yellow-600 transition">
            <i class="bi bi-plus-lg"></i> Nouveau Parcours
        </button>
    </div>

    <div class="grid gap-4 p-4">
        {% for path in paths %}
        <div class="bg-white p-5 rounded-3xl border border-gray-100 flex items-center justify-between shadow-sm">
            <div class="flex items-center space-x-4">
                <div class="w-20 h-20 bg-black rounded-2xl overflow-hidden shadow-inner">
                    <video class="w-full h-full object-cover opacity-80"><source src="{{ path.video_url }}"></video>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-800">{{ path.title }}</h3>
                    <span class="text-[10px] font-bold uppercase px-2 py-1 bg-gray-100 rounded-md text-gray-500">{{ path.get_type_parcours_display }}</span>
                </div>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'admin_panel:path_detail' path.id %}" class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i class="bi bi-list-ul"></i></a>
                <a href="{% url 'admin_panel:delete_path' path.id %}" class="p-3 bg-red-50 text-red-500 rounded-xl" onclick="return confirm('Supprimer ?')"><i class="bi bi-trash"></i></a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div x-show="showModal" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" x-cloak x-transition>
        <div class="bg-white rounded-3xl p-8 max-w-md w-full relative shadow-2xl" @click.away="!uploading && (showModal = false)">
            <h3 class="text-2xl font-bold mb-6 text-center">Nouveau Parcours</h3>
            
            <form method="POST" action="{% url 'admin_panel:create_path' %}" id="mainForm">
                {% csrf_token %}
                <div class="space-y-4">
                    <input type="text" name="title" placeholder="Titre (ex: Entrée Bakeli)" class="w-full p-4 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-yellow-400" required>
                    
                    <select name="type_parcours" class="w-full p-4 border border-gray-200 rounded-xl bg-white shadow-sm">
                        <option value="DESTINATION">Lieu unique</option>
                        <option value="ETAPE">Parcours à étapes</option>
                    </select>

                    <input type="hidden" name="video_url" :value="previewUrl" required>

                    <div @click="!uploading && $refs.fileInput.click()" 
                         class="relative w-full min-h-[200px] border-2 border-dashed rounded-3xl flex flex-col items-center justify-center cursor-pointer transition-all overflow-hidden"
                         :class="previewUrl ? 'border-green-500 bg-black' : 'border-gray-200 hover:border-yellow-500 bg-gray-50'">
                        
                        <input type="file" x-ref="fileInput" accept="video/*" capture="environment" class="hidden" @change="handleUpload">

                        <div x-show="!uploading && !previewUrl" class="text-center p-4">
                            <i class="bi bi-camera-video text-4xl text-gray-300"></i>
                            <p class="text-sm text-gray-400 mt-2 font-semibold">Cliquer pour filmer ou choisir</p>
                        </div>

                        <div x-show="uploading" class="w-full px-8">
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold text-gray-500">Téléchargement...</span>
                                <span class="text-xs font-bold text-yellow-600" x-text="progress + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-yellow-500 h-3 rounded-full transition-all duration-300" :style="'width:' + progress + '%'"></div>
                            </div>
                        </div>

                        <template x-if="previewUrl">
                            <div class="absolute inset-0 w-full h-full">
                                <video :src="previewUrl" class="w-full h-full object-cover opacity-60"></video>
                                <div class="absolute inset-0 flex flex-col items-center justify-center bg-black/30">
                                    <i class="bi bi-check-circle-fill text-4xl text-green-400 drop-shadow-lg"></i>
                                    <p class="text-white text-xs font-black mt-2 uppercase tracking-widest">Vidéo prête !</p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="flex justify-end space-x-3 pt-6">
                        <button type="button" @click="showModal = false" :disabled="uploading" class="px-5 py-2 text-gray-400 font-bold disabled:opacity-30">Annuler</button>
                        <button type="submit" :disabled="!previewUrl || uploading" 
                                class="px-10 py-3 bg-black text-white font-black rounded-2xl shadow-xl disabled:bg-gray-200 disabled:text-gray-400 transition-all transform active:scale-95">
                            ENREGISTRER
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function handleUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const app = document.getElementById('path-app');
    const data = Alpine.$data(app);
    
    data.uploading = true;
    data.progress = 0;
    data.previewUrl = '';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'tektal_preset'); // Ton preset Unsigned
    
    const cloudName = 'dqcc8n1th'; // Ton Cloud Name

    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, true);

    xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
            data.progress = Math.round((e.loaded / e.total) * 100);
        }
    };

    xhr.onload = () => {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            data.previewUrl = response.secure_url; // C'est ICI que le bouton s'active !
            data.uploading = false;
        } else {
            const err = JSON.parse(xhr.responseText);
            alert("Erreur Cloudinary : " + err.error.message);
            data.uploading = false;
        }
    };

    xhr.onerror = () => {
        alert("Problème de connexion internet.");
        data.uploading = false;
    };

    xhr.send(formData);
}
</script>

<style>
    [x-cloak] { display: none !important; }
</style>
  {% endblock %}